import type { CategoryNode } from '@/utils/parseExcel';
import { db } from '@/db/drizzle';
import { categories, products } from '@/schema';

type ProductInput = {
  name: string;
  description: string;
  price: string;
  unit: string;
  sku: string;
  quantity: number;
  categoryId: number | null;
};

export async function importFullCatalog(tree: CategoryNode) {
  console.log('‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...');
  await db.delete(products);
  await db.delete(categories);
  console.log('‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–∏–Ω–∞—é –∏–º–ø–æ—Ä—Ç...');

  const allProducts: ProductInput[] = [];

  await importTree(tree, null, allProducts);

  console.log(`üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏: ${allProducts.length}`);
  const chunkSize = 500;

  for (let i = 0; i < allProducts.length; i += chunkSize) {
    const chunk = allProducts.slice(i, i + chunkSize).map((product) => ({
      ...product,
      quantity: product.quantity != null ? String(product.quantity) : null
    }));
    await db.insert(products).values(chunk);
    console.log(
      `‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${i + chunk.length}/${allProducts.length}`
    );
  }

  console.log('üéâ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.');
}

async function importTree(
  node: CategoryNode,
  parentCategoryId: number | null,
  productAccumulator: ProductInput[]
): Promise<void> {
  for (const [key, value] of Object.entries(node)) {
    if (key === '_products') {
      const prods = value as any[];

      for (const product of prods) {
        const quantityNumber =
          typeof product.quantity === 'string'
            ? parseFloat(product.quantity.replace(/,/g, ''))
            : product.quantity;

        productAccumulator.push({
          ...product,
          quantity: quantityNumber,
          categoryId: parentCategoryId
        });
      }
      continue;
    }

    const [createdCategory] = await db
      .insert(categories)
      .values({
        name: key,
        categoryId: parentCategoryId
      })
      .returning();

    console.log(`üìÇ –°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${createdCategory?.name}`);

    if (createdCategory && createdCategory.id !== undefined) {
      await importTree(
        value as CategoryNode,
        createdCategory.id,
        productAccumulator
      );
    } else {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç id');
    }
  }
}
